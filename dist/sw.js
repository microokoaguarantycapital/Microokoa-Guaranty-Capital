const CACHE_NAME="microokoa-v1.0.0";const urlsToCache=["/","/index.html","/styles.min.css","/script.min.js","/vendor.css","/vendor.js","/manifest.json","/assets/logo.svg","/assets/favicon.ico","/assets/icon-192x192.png","/assets/icon-512x512.png","https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap"];self.addEventListener("install",e=>{console.log("Service Worker installing...");e.waitUntil(caches.open(CACHE_NAME).then(e=>{console.log("Caching app shell");return e.addAll(urlsToCache)}).then(()=>self.skipWaiting()))});self.addEventListener("activate",e=>{console.log("Service Worker activating...");e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==CACHE_NAME)return console.log("Deleting old cache:",e),caches.delete(e)}))).then(()=>self.clients.claim()))});self.addEventListener("fetch",e=>{if(!e.request.url.startsWith(self.location.origin))return;if("GET"!==e.request.method)return;e.respondWith(caches.match(e.request).then(t=>{if(t)return t;return fetch(e.request).then(t=>{if(!t||200!==t.status||"basic"!==t.type)return t;const n=t.clone();return caches.open(CACHE_NAME).then(e=>e.put(e.request,n)),t}).catch(()=>"navigate"===e.request.mode?caches.match("/"):new Response("Network error occurred",{status:408,headers:{"Content-Type":"text/plain"}}))}))});self.addEventListener("sync",e=>{"donation-sync"===e.tag&&(console.log("Background sync for donations"),e.waitUntil(syncDonations()))});async function syncDonations(){try{const e=await openDonationDB(),t=await getAllPendingDonations(e);for(const n of t)try{const e=await fetch("https://api.microokoa.com/donations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});e.ok&&(await markDonationAsSynced(e,n.id),console.log("Donation synced:",n.id))}catch(e){console.error("Failed to sync donation:",e)}}catch(e){console.error("Sync error:",e)}}self.addEventListener("push",e=>{console.log("Push notification received");const t=e.data?e.data.json():{},n=t.title||"Microokoa Guaranty Capital",o={body:t.body||"You have a new notification",icon:"/assets/icon-192x192.png",badge:"/assets/badge-72x72.png",vibrate:[100,50,100],data:{url:t.url||"/",dateOfArrival:Date.now(),primaryKey:t.primaryKey||"1"},actions:[{action:"open",title:"Open App"},{action:"close",title:"Close"}]};e.waitUntil(self.registration.showNotification(n,o))});self.addEventListener("notificationclick",e=>{console.log("Notification clicked"),e.notification.close(),"close"===e.action||e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(t=>{for(const n of t)if("/"===n.url&&"focus"in n)return n.focus();if(clients.openWindow)return clients.openWindow(e.notification.data.url||"/")}))});self.addEventListener("periodicsync",e=>{"update-rates"===e.tag&&(console.log("Periodic sync for rates update"),e.waitUntil(updateLoanRates()))});async function updateLoanRates(){try{const e=await fetch("https://api.microokoa.com/rates"),t=await e.json(),n=await caches.open(CACHE_NAME);await n.put("/rates",new Response(JSON.stringify(t))),console.log("Loan rates updated")}catch(e){console.error("Failed to update rates:",e)}}function openDonationDB(){return new Promise(((e,t)=>{const n=indexedDB.open("MicrookoaDonations",1);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result),n.onupgradeneeded=n=>{const t=n.target.result;t.objectStoreNames.contains("donations")||(t.createObjectStore("donations",{keyPath:"id"})).createIndex("status","status",{unique:!1})}}))}function getAllPendingDonations(e){return new Promise(((t,n)=>{const o=e.transaction(["donations"],"readonly"),c=o.objectStore("donations"),l=c.index("status"),s=l.getAll("pending");s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}))}function markDonationAsSynced(e,t){return new Promise(((n,o)=>{const c=e.transaction(["donations"],"readwrite"),l=c.objectStore("donations"),s=l.get(t);s.onerror=()=>o(s.error),s.onsuccess=()=>{const e=s.result;e.status="synced",e.syncedAt=new Date().toISOString();const o=l.put(e);o.onerror=()=>n(o.error),o.onsuccess=()=>n()}}))}