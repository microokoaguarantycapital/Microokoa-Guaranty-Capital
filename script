document.addEventListener('DOMContentLoaded', () => {
  // Menu toggle for mobile
  const menuToggle = document.querySelector('.menu-toggle');
  const mainNav = document.querySelector('.main-nav');

  menuToggle.addEventListener('click', () => {
    const expanded = menuToggle.getAttribute('aria-expanded') === 'true' || false;
    menuToggle.setAttribute('aria-expanded', !expanded);
    mainNav.classList.toggle('open');
  });

  // Dropdown aria expand toggle
  const dropdownParents = document.querySelectorAll('.has-dropdown > a');
  dropdownParents.forEach(parent => {
    parent.addEventListener('click', e => {
      e.preventDefault();
      const expanded = parent.getAttribute('aria-expanded') === 'true';
      parent.setAttribute('aria-expanded', !expanded);
      const submenu = parent.nextElementSibling;
      if (submenu) {
        submenu.style.display = expanded ? 'none' : 'block';
      }
    });
  });

  // Accordion FAQ toggle
  const accordionBtn = document.querySelector('.has-accordion > button');
  const accordionContent = document.querySelector('#faqs-content');

  accordionBtn?.addEventListener('click', () => {
    const expanded = accordionBtn.getAttribute('aria-expanded') === 'true';
    accordionBtn.setAttribute('aria-expanded', !expanded);
    if (!expanded) {
      accordionContent.removeAttribute('hidden');
    } else {
      accordionContent.setAttribute('hidden', '');
    }
  });

  // Loan Calculators

  function updateLoanCalculator(sliderId, donationOutputId, loanAccessId) {
    const slider = document.getElementById(sliderId);
    const donationOutput = document.getElementById(donationOutputId);
    const loanAccess = document.getElementById(loanAccessId);

    if (!slider || !donationOutput || !loanAccess) return;

    slider.addEventListener('input', () => {
      const donationValue = parseInt(slider.value, 10);
      donationOutput.value = `Ksh ${donationValue.toLocaleString()}`;
      loanAccess.textContent = `Ksh ${ (donationValue * 10).toLocaleString() }`;
    });

    // Initialize on load
    slider.dispatchEvent(new Event('input'));
  }
  updateLoanCalculator('donationRange', 'donationValue', 'loanAccess');
  updateLoanCalculator('donationRangeMain', 'donationValueMain', 'loanAccessMain');

  // Testimonials Carousel

  let testimonialIndex = 0;
  const testimonials = document.querySelectorAll('.testimonial');
  const prevBtn = document.querySelector('.carousel-prev');
  const nextBtn = document.querySelector('.carousel-next');

  if (testimonials.length > 0) {
    function showTestimonial(index) {
      testimonials.forEach((t, i) => {
        t.classList.toggle('active', i === index);
        t.setAttribute('aria-hidden', i !== index);
      });
    }

    function nextTestimonial() {
      testimonialIndex = (testimonialIndex + 1) % testimonials.length;
      showTestimonial(testimonialIndex);
    }

    function prevTestimonial() {
      testimonialIndex = (testimonialIndex - 1 + testimonials.length) % testimonials.length;
      showTestimonial(testimonialIndex);
    }

    showTestimonial(testimonialIndex);

    nextBtn.addEventListener('click', nextTestimonial);
    prevBtn.addEventListener('click', prevTestimonial);

    // Auto rotate every 5s
    setInterval(nextTestimonial, 5000);
  }
});
